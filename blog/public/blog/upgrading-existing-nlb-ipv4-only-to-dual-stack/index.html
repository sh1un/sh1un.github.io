<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/>
<meta name="robots" content="index, follow" />
<title>
  如何將現有 NLB IPv4-only 架構升級為 Dual-stack | Shiun
</title>
<meta
  name="keywords"
  content="AWS NLB 升級, IPv4 到 IPv6 遷移, Dual-stack 配置, AWS 負載均衡器, AWS 網路架構, NLB target group 設定, IPv6 網路配置, AWS VPC 設定, AWS NLB migration, IPv4 to IPv6 migration, Dual-stack configuration, AWS load balancer, Network architecture, Target group configuration, IPv6 networking, VPC configuration, Cloud infrastructure upgrade, Network Load Balancer setup, Security group settings, IPv6 migration guide, AWS network migration, Load balancer upgrade"
/> <meta name="description" content="本文將透過圖文，詳細地引導您如何將現有的 IPv4 Network Load Balancer (NLB) 架構升級為支援 dual-stack（同時支援 IPv4 和 IPv6）的配置。"> <meta name="author" content=""> <link rel="canonical" href="https://shiun.me/blog/upgrading-existing-nlb-ipv4-only-to-dual-stack/">
<link
  crossorigin="anonymous"
  href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css"
  integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A="
  rel="preload stylesheet"
  as="style"
/> <link rel="icon" href="https://github.com/sh1un/sh1un.github.io/assets/85695943/12a1e84f-ed17-4e38-8165-f67783c7f047"> <link
rel="icon" type="image/png" sizes="16x16" href="https://shiun.me/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://shiun.me/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://shiun.me/apple-touch-icon.png"> <link rel="mask-icon" href="https://shiun.me/safari-pinned-tab.svg"> <meta name="theme-color" content="#2e2e33"> <meta name="msapplication-TileColor" content="#2e2e33"> <link rel="alternate" hreflang="en" href="https://shiun.me/blog/upgrading-existing-nlb-ipv4-only-to-dual-stack/" />


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-RZR8D4ERKG"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-RZR8D4ERKG');
        }
      </script>


<meta property="og:url" content="https://shiun.me/blog/upgrading-existing-nlb-ipv4-only-to-dual-stack/">
  <meta property="og:site_name" content="Shiun">
  <meta property="og:title" content="如何將現有 NLB IPv4-only 架構升級為 Dual-stack">
  <meta property="og:description" content="本文將透過圖文，詳細地引導您如何將現有的 IPv4 Network Load Balancer (NLB) 架構升級為支援 dual-stack（同時支援 IPv4 和 IPv6）的配置。">
  <meta property="og:locale" content="zh_tw">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2025-01-08T23:36:55+08:00">
    <meta property="article:modified_time" content="2025-01-08T23:36:55+08:00">
    <meta property="article:tag" content="AWS">
    <meta property="article:tag" content="AWS Networking">
    <meta property="article:tag" content="AWS ELB">
    <meta property="article:tag" content="AWS NLB">
    <meta property="article:tag" content="Dual-Stack">
    <meta property="article:tag" content="IPv6">
    <meta property="og:image" content="https://github.com/sh1un/sh1un.github.io/assets/85695943/42e903b9-06db-4cd8-b937-590a3cb26aea">




  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://github.com/sh1un/sh1un.github.io/assets/85695943/42e903b9-06db-4cd8-b937-590a3cb26aea">
  <meta name="twitter:title" content="如何將現有 NLB IPv4-only 架構升級為 Dual-stack">
  <meta name="twitter:description" content="本文將透過圖文，詳細地引導您如何將現有的 IPv4 Network Load Balancer (NLB) 架構升級為支援 dual-stack（同時支援 IPv4 和 IPv6）的配置。">


<noscript>
  <style>
    #theme-toggle,
    .top-link {
      display: none;
    }
  </style>
  <style>
    @media (prefers-color-scheme: dark) {
      :root {
        --theme: rgb(29, 30, 32);
        --entry: rgb(46, 46, 51);
        --primary: rgb(218, 218, 219);
        --secondary: rgb(155, 156, 157);
        --tertiary: rgb(65, 66, 68);
        --content: rgb(196, 196, 197);
        --code-block-bg: rgb(46, 46, 51);
        --code-bg: rgb(55, 56, 62);
        --border: rgb(51, 51, 51);
      }

      .list {
        background: var(--theme);
      }

      .list:not(.dark)::-webkit-scrollbar-track {
        background: 0 0;
      }

      .list:not(.dark)::-webkit-scrollbar-thumb {
        border-color: var(--theme);
      }
    }
  </style>
</noscript>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-RZR8D4ERKG"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-RZR8D4ERKG');
        }
      </script><meta property="og:title" content="如何將現有 NLB IPv4-only 架構升級為 Dual-stack" />
<meta property="og:description" content="本文將透過圖文，詳細地引導您如何將現有的 IPv4 Network Load Balancer (NLB) 架構升級為支援 dual-stack（同時支援 IPv4 和 IPv6）的配置。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shiun.me/blog/upgrading-existing-nlb-ipv4-only-to-dual-stack/" /><meta property="og:image" content="https://github.com/sh1un/sh1un.github.io/assets/85695943/42e903b9-06db-4cd8-b937-590a3cb26aea"/><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2025-01-08T23:36:55+08:00" />
<meta property="article:modified_time" content="2025-01-08T23:36:55+08:00" /><meta property="og:site_name" content="Shiun&#39;s Blog" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://github.com/sh1un/sh1un.github.io/assets/85695943/42e903b9-06db-4cd8-b937-590a3cb26aea"/>

<meta name="twitter:title" content="如何將現有 NLB IPv4-only 架構升級為 Dual-stack"/>
<meta name="twitter:description" content="本文將透過圖文，詳細地引導您如何將現有的 IPv4 Network Load Balancer (NLB) 架構升級為支援 dual-stack（同時支援 IPv4 和 IPv6）的配置。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://shiun.me/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "如何將現有 NLB IPv4-only 架構升級為 Dual-stack",
      "item": "https://shiun.me/blog/upgrading-existing-nlb-ipv4-only-to-dual-stack/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "如何將現有 NLB IPv4-only 架構升級為 Dual-stack",
  "name": "如何將現有 NLB IPv4-only 架構升級為 Dual-stack",
  "description": "本文將透過圖文，詳細地引導您如何將現有的 IPv4 Network Load Balancer (NLB) 架構升級為支援 dual-stack（同時支援 IPv4 和 IPv6）的配置。",
  "keywords": [
    "AWS NLB 升級", "IPv4 到 IPv6 遷移", "Dual-stack 配置", "AWS 負載均衡器", "AWS 網路架構", "NLB target group 設定", "IPv6 網路配置", "AWS VPC 設定", "AWS NLB migration", "IPv4 to IPv6 migration", "Dual-stack configuration", "AWS load balancer", "Network architecture", "Target group configuration", "IPv6 networking", "VPC configuration", "Cloud infrastructure upgrade", "Network Load Balancer setup", "Security group settings", "IPv6 migration guide", "AWS network migration", "Load balancer upgrade"
  ],
  "articleBody": "目標 將現有的 IPv4-only NLB 升級為支援 dual-stack 讓 Target Group 從純 IPv4 轉換為支援 IPv6 確保整個架構能同時處理 IPv4 和 IPv6 的流量 我們將逐步完成這個轉換過程，包括配置 VPC、更新 NLB 設置、修改 security groups，以及設定 target groups。每個步驟都會提供詳細的操作說明和技術細節，幫助您順利完成這個升級過程。\n現有架構 現在的架構是一個很基本的 IPv4 NLB(Internet-facing) → Target Group (IPv4 Instance type ) 的架構\n點擊展開以查看詳細內容 VPC NLB\nDetails Security Group Target Group\nInstance Security Group Section 1: NLB IPv4 → Dual-stack Step 1: VPC 新增 IPv6 CIDR 進入 VPC 頁面：\n選取 VPC 展開 Actions menu 點擊 Edit CIDRs 新增 IPv6 CIDR：\n點擊 Add new IPv6 CIDR 選擇 Amazon-provided IPv6 CIDR block Step 2: 為 NLB ENI 所處的 Subnet 分配 IPv6 CIDR 在 AWS Console 常常都會迷路，要配置的東西很多，又散亂在不同地方，所以我習慣到 NLB 的頁面直接找到他所處的 Subnet，如下圖，可以看到 NLB Details 頁面中有一個 Availability Zones 的地方下面的連結就是 Subnet 連結\n成功進入 Subnet Details 頁面後：\n展開 Actions menu 點擊 Edit IPv6 CIDRs 從 VPC CIDR 中，切一個 /64 的 IPv6 CIDR 給這 Subnet\nStep 3: 更新 NLB IP address type 當 NLB 所在的 Subnet 已經分配了 IPv6 CIDR 範圍時，可以為 NLB 的 ENI 分配 IPv6 address。不過，NLB 的 ENI 是由 AWS 自動管理，我們無法直接操作或管理這些 ENI。要為 NLB 的 ENI 分配 IPv6 address，需要修改 NLB 的 IP address type，例如將其設定為 dualstack，AWS 會自動為 ENI 分配對應的 IPv6 位址。\n更改 NLB address type 前，可以去觀察一下 NLB 的 ENI，確實還沒有 IPv6 address (下圖紅框所示)\n回到 NLB Details 頁面：\n展開 Actions menu 點擊 Edit IP address type 把 Load balancer IP address type 改成 Dualstack\n再次回到 ENI 頁面，再次觀察 NLB 的 ENI ，可以注意到，已經從 Subnet CIDR 中 Assign 一個 IPv6 address 給 NLB ENI 了 (下圖紅框處)\nStep 4: 修改 NLB 的 Security Group 允許 IPv6 流量 我們的 NLB 是 Internet-facing 的，原本的 Security Group 只允許任何來源的 IPv4 流量，但我們要接收 IPv6 Client 的流量，勢必就需要修改 Security Group 以允許 IPv6 的流量進入 NLB。\n要找到他的 Security Group：\n可以進入 NLB Detail 的頁面中 \u003e Security 頁籤 就可以找到這個 NLB 的 SG (Security Group) 進入 Security Group 頁面：\n點擊 Edit inbound rules 配置 Inbound rule 允許 IPv6 流量：\n點擊 Add rule Type: HTTP Source: Anywhere-IPv6 Description: Allow all HTTP traffic (IPv6) 現在可以測試看看能不能把請求成功打進去 NLB 而且還得到回應， curl -6 是 curl 工具的一個選項，專門用於指定使用 IPv6 進行請求，如果要用 IPv4 進行請求就是用 -4\n請把 curl -6 後面那串換成你自己的 NLB domain name\n請把 curl -6 後面那串換成你自己的 NLB domain name\n請把 curl -6 後面那串換成你自己的 NLB domain name\ncurl -6 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com 你會發現打不通，沒有回應！！\n你會發現打不通，沒有回應！！\n你會發現打不通，沒有回應！！\nStep 5: 修改 Route table 以允許 IPv6 流量出去 為什麼剛才發出 HTTP 請求後得不到回應呢？原因是：\n上方指令，我強制使用 IPv6，所以我們是 IPv6 Client 因為 NLB 想要把流量打到外面去，但是路由表內並沒有匹配的 Route 允許他說「當目的地是 XXX IPv6 地址時，下一跳要給誰」 所以我們要修改 Route Table，NLB 才有辦法把流量送回來我們這裡 所以！！現在要來修改 NLB ENI 所處的 Subnet 其關聯的 Route table，確保其有 ::/0 相關的規則，讓 IPv6 流量可以出去 VPC\n進入 NLB Detail 頁面中，點擊 Availability Zones 下方的連結，找到 NLB 所在的 Subnet\n進入 VPC Subnets Details 頁面點擊 Route Table\n進入 Route table 頁面：\n勾選 Route Table 展開 Actions menu 點擊 Edit routes 新增 route:\nDestination: ::/0 Target: Internet Gateway 改好後，再次發出 HTTP 請求\n$ curl -6 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com Hello World from ip-10-0-138-176.us-west-2.compute.internal 太棒了！！終於收到 Response 了，到這邊，其實可以算是遷移到 Dual-stack 的目標完成一半了！\n但是我要追求的是 Fully dual-stack! 也就是 Target Group 那邊也是要 Dual-stack\n(Optional) SSH 連線到 Target Group 的 Instance 觀察 Logs 我這邊有用跳板機，連線進去 Target Group 的 Instance 捕捉一下 Private IPv4 Instance 的 Apache httpd Logs，執行以下指令就可以查看 Logs：\nsudo tail -f /var/log/httpd/access_log 一樣我先回到自己電腦，用 curl 命令對 NLB 發出請求：\ncurl -6 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com 然後回到 EC2 Instance 查看 httpd access logs，可以觀察到，來源地址是 NLB 的 Private IPv4 address (10.0.9.20):\n10.0.9.20 - - [07/Jan/2025:20:49:00 +0000] \"GET / HTTP/1.1\" 200 69 \"-\" \"ELB-HealthChecker/2.0\" 10.0.9.20 - - [07/Jan/2025:20:49:02 +0000] \"GET / HTTP/1.1\" 200 69 \"-\" \"curl/8.7.1\" 透過這個觀察，我們可以知道，當我身為 IPv6 Client，向 NLB 發出 HTTP 請求後，當流量到達時 NLB ，NLB 會利用自身的 Private IPv4 address 去和 Target 通信，這也是為什麼我們在 EC2 Instance 觀察 httpd access log 時，看到的來源 IP 地址並不是我電腦的 IPv6 address，而是 NLB 的 Private IPv4 address。\n當然我們也可以觀察用 IPv4 去調用，會怎樣：\ncurl -4 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com 一樣回到 EC2 Instance 查看 httpd access log，觀察到這裡可以直接看見我電腦的 IPv4 address:\n61.64.29.207 - - [08/Jan/2025:01:33:29 +0000] \"GET / HTTP/1.1\" 200 69 \"-\" \"curl/8.7.1\" 會這樣是因為流量從頭到尾都是 IPv4，NLB 不需要在中間幫我們做任何協議的轉換：\nIPv4 Client -\u003e Dual-stack NLB -\u003e IPv4 Target Group Instance (Optional) 利用 VPC Flow logs 觀察 NLB 的回應 VPC Flow Logs 的建置不是本文重點，關於怎麼建置在煩請查閱 AWS 官方文檔\n我建立了 VPC Flow logs 來觀察 NLB 的 ENI，於是觀察到以下東西：\nNLB 確實是以自身 IPv6 address 作為來源地址，將後端應用 (Target Group) 的 Response 回傳到我的電腦\n為什麼 VPC Flow logs 上面沒見到任何我的筆電 IPv6 地址作為 src？只有看到我的筆電 IPv6 被作為 dst?? 可以看下圖\n其實即便我今天是 IPv4 Client 也是一樣，就是看不到我的 IP 地址被作為 src 記錄在 VPC Flow logs 這個問題真的讓我很匪夷所思，想了很久，只能**猜測：**某些流量在 NLB 的內部處理過程中未經過 ENI，或者經過特殊的封包處理路徑，這些流量可能不會被 Flow Logs 捕捉到。 (純屬猜測，如果有人知道正確答案希望能分享讓我知道，真的很想探究背後的原因) NLB IPv6 address: 2600:1f14:2549:300:17c1:6c5d:ba29:ce1 My IPv6 address: 2407:4b00:1c02:77d9:8041:f560:157a:c42c\nSection2: 讓 Target Group 也變成 Dual-stack Step 1: 分配 IPv6 CIDR 給 Target Group 的 Instance 所處 subnet 要找到 EC2 所處的 Subnet，我習慣進入 EC2 頁面，直接找到這台 EC2 所處的 Subnet\n進入 VPC Subnet 頁面：\n選取 Subnet 展開 Actions menu 點擊 Edit IPv6 CIDR 從 VPC 中分配一個 /64 的 IPv6 CIDR 子網給他\n**注意：**配給這個子網的 CIDR 不要和同 VPC 中的其他 Subnet CIDRs 有 Overlapping!\nStep2: Assign IPv6 address 給 Instance 進入 EC2 頁面：\n選取 Instance 展開 Actions Menu 點擊 Networking 點擊 Manage IP addresses Assign IPv6 Address:\n展開 eth0 在 IPv6 addresses 的 Section 下，點擊 Assign new IP address，欄位可以不填寫，他會從子網的 IPv6 CIDR 中 Auto-assign Step 3: 建立 IPv6 Instance type target group 進入 EC2 \u003e Target Group 頁面：\n點擊 Create Target Group 依照下方配置 Target Group\nTarget type: Instances Target group name: ipv6-private-instance-tg Protocol: Port TCP 80 IP address type: IPv6 VPC: Instance 所處的 VPC 其他保持預設，然後按下 Next\nRegister targets:\n點擊 Unassigned Manage IP addresses 成功進到 Manage IP addresses 頁面：\n展開 eth0 勾選 Enable Assign primary IPv6 IP 點擊 Save 回到剛才 Target Group 的頁面：\n點擊右上角 Refresh icon (如下圖紅框所示) 成功的話，你會看到表格中 Primary IPv6 address 欄位從原本的 Unassigned 變成顯示對應的 IPv6 address Register targets:\n勾選 instance 點擊 Include as pending below 點擊 Create target group Step 4: 修改 NLB Listener 的 Target 在 NLB 中，一個 Listener（例如 TCP 80 Port Listener）背後只能關聯一個 Target Group，無法同時直接關聯多個 Target Group。\n要跟上趨勢當然就要用 IPv6，所以就來把原本的 IPv4 Target 改成剛才創建好的 IPv6 Target\n進入 NLB Detail 頁面：\n勾選 Listener 點擊 Edit listener 修改成剛才所創建的 IPv6 Target Group\n切換 TG 後，需要等一下下，因為 NLB 還要做 Health Check 需要一點時間\n這時候我回到先前所 SSH 連線的 EC2 Instance 持續觀察 httpd access log 也會發現 Health check 的流量，從原本的 NLB Private IPv4 address 變成 NLB IPv6 address\n補充： 這是目前 NLB ENI 被 Assign 的 Addresses NLB Private IPv4 address: 10.0.9.20 NLB IPv6 address: 2600:1f14:2549:300:7935:fbac:a7b4:84d5\n到這裡，我們已經成功把 Target Group 升級成 Dual-stack 了！\nStep 5: 測試 IPv6 流量 現在我們來使用 curl -6 指令向 Dual-stack NLB 發出 HTTP 請求：\ncurl -6 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com 流量路徑會是：\nIPv6 Client -\u003e Dual-stack NLB (Layer 4) -\u003e IPv6 Target Group Instance NLB 運作於第 4 層（傳輸層），專門處理傳輸層協議（如 TCP 和 UDP）的流量。由於 NLB 不會對應用層數據進行處理，因此它可以保留封包的原始來源 IP 地址，使後端 Target Group（例如 EC2 Instances）能直接看到 Client 的 IP 地址。\n但是要注意，不同的 Target Group 配置會讓保留原始 Client IP 行為略有不同：\nTarget Group 使用實例 ID（Instance ID）： NLB 會直接保留原始的 Client IP 地址，無需額外設定。 Target Group 使用 IP 地址（IP Address）： 如果使用的是 TCP 或 TLS 協議，NLB 預設不會保留 Client IP 地址。在這種情況下，可以啟用 Proxy Protocol v2，以將原始的 Client IP 地址嵌入到傳遞給目標的封包中。 以下是 Target Instance 上 httpd 的 access log，可以看到記錄的是客戶端的 IPv6 地址 2407:4b00:1c02:77d9:8041:f560:157a:c42c (這就是我電腦的 IPv6 address):\n2407:4b00:1c02:77d9:8041:f560:157a:c42c - - [07/Jan/2025:22:01:05 +0000] \"GET / HTTP/1.1\" 200 69 \"-\" \"curl/8.7.1\" 也來試試看 IPv4 Client 發出 HTTP 請求：\ncurl -4 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com 你會發現後端看到的來源 IP 是 NLB 的 IPv6 address\n2600:1f14:2549:300:17c1:6c5d:ba29:ce1 - - [08/Jan/2025:02:08:26 +0000] \"GET / HTTP/1.1\" 200 69 \"-\" \"curl/8.7.1\" (Optional) 既然 NLB 會幫我做協議轉換，那我還是想看到原始客戶端 IP 地址怎麼辦？ 這時候就需要 Proxy Protocol 的幫助了！\n由於這部分不是本文重點，要怎麼在配置 Proxy Protocol 來讓你的 Server 支援 Proxy Protocol 可以參考我的 Notion 筆記，但我這個筆記中是以 Nginx 為示範，跟本文使用 Httpd 不一樣唷：\n連結：配置 Nginx 支持 Proxy Protocol v2 若之後有時間我會重新整理 Notion 筆記中的 Proxy Protocol 的配置，再上傳到部落格\nResources VPC CIDR blocks - Amazon Virtual Private Cloud Logging IP traffic using VPC Flow Logs - Amazon Virtual Private Cloud 配置 Nginx 支持 Proxy Protocol v2 - Shiun Notion 如何將現有 NLB IPv4-only 架構升級為 Dual-stack - Shiun Notion Dual-stack network design in AWS - Shiun Notion Dual-stack IPv6 architectures for AWS and hybrid networks | Amazon Web Services ",
  "wordCount" : "1170",
  "inLanguage": "en",
  "datePublished": "2025-01-08T23:36:55+08:00",
  "dateModified": "2025-01-08T23:36:55+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://shiun.me/blog/upgrading-existing-nlb-ipv4-only-to-dual-stack/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Shiun",
    "logo": {
      "@type": "ImageObject",
      "url": "https://github.com/sh1un/sh1un.github.io/assets/85695943/12a1e84f-ed17-4e38-8165-f67783c7f047"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://shiun.me/" accesskey="h" title="Shiun (Alt + H)">Shiun</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://shiun.me/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://shiun.me/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://shiun.me/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://shiun.me/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://shiun.notion.site/Shiun-s-Learning-Journal-ded4cd4a3efd47b2805f2f99dee8f9a1?pvs=4" title="Notion">
                    <span>Notion</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://www.linkedin.com/in/shiunchiu" title="About me">
                    <span>About me</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://shiun.me/">Home</a>&nbsp;»&nbsp;<a href="https://shiun.me/blog/">Blogs</a></div>
    <h1 class="post-title entry-hint-parent">
      如何將現有 NLB IPv4-only 架構升級為 Dual-stack
    </h1>
    <div class="post-description">
      本文將透過圖文，詳細地引導您如何將現有的 IPv4 Network Load Balancer (NLB) 架構升級為支援 dual-stack（同時支援 IPv4 和 IPv6）的配置。
    </div>
    <div class="post-meta"><span title='2025-01-08 23:36:55 +0800 CST'>January 8, 2025</span>&nbsp;·&nbsp;6 min

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%9b%ae%e6%a8%99" aria-label="目標">目標</a></li>
                <li>
                    <a href="#%e7%8f%be%e6%9c%89%e6%9e%b6%e6%a7%8b" aria-label="現有架構">現有架構</a></li>
                <li>
                    <a href="#section-1-nlb-ipv4--dual-stack" aria-label="Section 1: NLB IPv4 → Dual-stack">Section 1: NLB IPv4 → Dual-stack</a><ul>
                        
                <li>
                    <a href="#step-1-vpc-%e6%96%b0%e5%a2%9e-ipv6-cidr" aria-label="Step 1: VPC 新增 IPv6 CIDR">Step 1: VPC 新增 IPv6 CIDR</a></li>
                <li>
                    <a href="#step-2-%e7%82%ba-nlb-eni-%e6%89%80%e8%99%95%e7%9a%84-subnet-%e5%88%86%e9%85%8d-ipv6-cidr" aria-label="Step 2: 為 NLB ENI 所處的 Subnet 分配 IPv6 CIDR">Step 2: 為 NLB ENI 所處的 Subnet 分配 IPv6 CIDR</a></li>
                <li>
                    <a href="#step-3-%e6%9b%b4%e6%96%b0-nlb-ip-address-type" aria-label="Step 3: 更新 NLB IP address type">Step 3: 更新 NLB IP address type</a></li>
                <li>
                    <a href="#step-4-%e4%bf%ae%e6%94%b9-nlb-%e7%9a%84-security-group-%e5%85%81%e8%a8%b1-ipv6-%e6%b5%81%e9%87%8f" aria-label="Step 4: 修改 NLB 的 Security Group 允許 IPv6 流量">Step 4: 修改 NLB 的 Security Group 允許 IPv6 流量</a></li>
                <li>
                    <a href="#step-5-%e4%bf%ae%e6%94%b9-route-table-%e4%bb%a5%e5%85%81%e8%a8%b1-ipv6-%e6%b5%81%e9%87%8f%e5%87%ba%e5%8e%bb" aria-label="Step 5: 修改 Route table 以允許 IPv6 流量出去">Step 5: 修改 Route table 以允許 IPv6 流量出去</a></li>
                <li>
                    <a href="#optional-ssh-%e9%80%a3%e7%b7%9a%e5%88%b0-target-group-%e7%9a%84-instance-%e8%a7%80%e5%af%9f-logs" aria-label="(Optional) SSH 連線到 Target Group 的 Instance 觀察 Logs">(Optional) SSH 連線到 Target Group 的 Instance 觀察 Logs</a></li>
                <li>
                    <a href="#optional-%e5%88%a9%e7%94%a8-vpc-flow-logs-%e8%a7%80%e5%af%9f-nlb-%e7%9a%84%e5%9b%9e%e6%87%89" aria-label="(Optional) 利用 VPC Flow logs 觀察 NLB 的回應">(Optional) 利用 VPC Flow logs 觀察 NLB 的回應</a></li></ul>
                </li>
                <li>
                    <a href="#section2-%e8%ae%93-target-group-%e4%b9%9f%e8%ae%8a%e6%88%90-dual-stack" aria-label="Section2: 讓 Target Group 也變成 Dual-stack">Section2: 讓 Target Group 也變成 Dual-stack</a><ul>
                        
                <li>
                    <a href="#step-1-%e5%88%86%e9%85%8d-ipv6-cidr-%e7%b5%a6-target-group-%e7%9a%84-instance-%e6%89%80%e8%99%95-subnet" aria-label="Step 1: 分配 IPv6 CIDR 給 Target Group 的 Instance 所處 subnet">Step 1: 分配 IPv6 CIDR 給 Target Group 的 Instance 所處 subnet</a></li>
                <li>
                    <a href="#step2-assign-ipv6-address-%e7%b5%a6-instance" aria-label="Step2: Assign IPv6 address 給 Instance">Step2: Assign IPv6 address 給 Instance</a></li>
                <li>
                    <a href="#step-3-%e5%bb%ba%e7%ab%8b-ipv6-instance-type-target-group" aria-label="Step 3: 建立 IPv6 Instance type target group">Step 3: 建立 IPv6 Instance type target group</a></li>
                <li>
                    <a href="#step-4-%e4%bf%ae%e6%94%b9-nlb-listener-%e7%9a%84-target" aria-label="Step 4: 修改 NLB Listener 的 Target">Step 4: 修改 NLB Listener 的 Target</a></li>
                <li>
                    <a href="#step-5-%e6%b8%ac%e8%a9%a6-ipv6-%e6%b5%81%e9%87%8f" aria-label="Step 5: 測試 IPv6 流量">Step 5: 測試 IPv6 流量</a></li>
                <li>
                    <a href="#optional-%e6%97%a2%e7%84%b6-nlb-%e6%9c%83%e5%b9%ab%e6%88%91%e5%81%9a%e5%8d%94%e8%ad%b0%e8%bd%89%e6%8f%9b%e9%82%a3%e6%88%91%e9%82%84%e6%98%af%e6%83%b3%e7%9c%8b%e5%88%b0%e5%8e%9f%e5%a7%8b%e5%ae%a2%e6%88%b6%e7%ab%af-ip-%e5%9c%b0%e5%9d%80%e6%80%8e%e9%ba%bc%e8%be%a6" aria-label="(Optional) 既然 NLB 會幫我做協議轉換，那我還是想看到原始客戶端 IP 地址怎麼辦？">(Optional) 既然 NLB 會幫我做協議轉換，那我還是想看到原始客戶端 IP 地址怎麼辦？</a></li></ul>
                </li>
                <li>
                    <a href="#resources" aria-label="Resources">Resources</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="目標">目標<a hidden class="anchor" aria-hidden="true" href="#目標">#</a></h2>
<ul>
<li>將現有的 IPv4-only NLB 升級為支援 dual-stack</li>
<li>讓 Target Group 從純 IPv4 轉換為支援 IPv6</li>
<li>確保整個架構能同時處理 IPv4 和 IPv6 的流量</li>
</ul>
<p>我們將逐步完成這個轉換過程，包括配置 VPC、更新 NLB 設置、修改 security groups，以及設定 target groups。每個步驟都會提供詳細的操作說明和技術細節，幫助您順利完成這個升級過程。</p>
<hr>
<h2 id="現有架構">現有架構<a hidden class="anchor" aria-hidden="true" href="#現有架構">#</a></h2>
<p>現在的架構是一個很基本的 IPv4 NLB(Internet-facing) → Target Group (IPv4 Instance type ) 的架構</p>
<!-- raw HTML omitted -->
<p><img loading="lazy" src="Existing-NLB-IPv4-only-Architecture-Diagram.png" alt="Existing NLB IPv4-only Architecture Diagram.png"  />
</p>


<p><details >
  <summary markdown="span">點擊展開以查看詳細內容</summary>
  <ul>
<li>
<p>VPC
<img loading="lazy" src="image.png" alt="VPC Resource map"  />

<img loading="lazy" src="image%201.png" alt="VPC CIDR"  />
</p>
</li>
<li>
<p>NLB</p>
<ul>
<li>Details
<img loading="lazy" src="image%202.png" alt="NLB Details"  />
</li>
<li>Security Group
<img loading="lazy" src="image%203.png" alt="NLB Security Group"  />
</li>
</ul>
</li>
<li>
<p>Target Group</p>
<ul>
<li>Instance
<img loading="lazy" src="image%204.png" alt="Target Group instance"  />
</li>
<li>Security Group
<img loading="lazy" src="image%205.png" alt="Target Group instance SG"  />
</li>
</ul>
</li>
</ul>

</details></p>

<!-- raw HTML omitted -->
<hr>
<h2 id="section-1-nlb-ipv4--dual-stack">Section 1: NLB IPv4 → Dual-stack<a hidden class="anchor" aria-hidden="true" href="#section-1-nlb-ipv4--dual-stack">#</a></h2>
<h3 id="step-1-vpc-新增-ipv6-cidr">Step 1: VPC 新增 IPv6 CIDR<a hidden class="anchor" aria-hidden="true" href="#step-1-vpc-新增-ipv6-cidr">#</a></h3>
<p>進入 VPC 頁面：</p>
<ol>
<li>選取 <strong>VPC</strong></li>
<li>展開 <strong>Actions menu</strong></li>
<li>點擊 <strong>Edit CIDRs</strong></li>
</ol>
<p><img loading="lazy" src="image%206.png" alt="Edit CIDRs"  />
</p>
<p>新增 IPv6 CIDR：</p>
<ol>
<li>點擊 <strong>Add new IPv6 CIDR</strong></li>
<li>選擇 <strong>Amazon-provided IPv6 CIDR block</strong></li>
</ol>
<p><img loading="lazy" src="image%207.png" alt="Add new IPv6 CIDR"  />
</p>
<p><img loading="lazy" src="image%208.png" alt="Select Amazon-provided IPv6 CIDR block"  />
</p>
<h3 id="step-2-為-nlb-eni-所處的-subnet-分配-ipv6-cidr">Step 2: 為 NLB ENI 所處的 Subnet 分配 IPv6 CIDR<a hidden class="anchor" aria-hidden="true" href="#step-2-為-nlb-eni-所處的-subnet-分配-ipv6-cidr">#</a></h3>
<p>在 AWS Console 常常都會迷路，要配置的東西很多，又散亂在不同地方，所以我習慣到 NLB 的頁面直接找到他所處的 Subnet，如下圖，可以看到 NLB Details 頁面中有一個 <strong>Availability Zones 的地方下面的連結就是 Subnet 連結</strong></p>
<p><img loading="lazy" src="image%209.png" alt="Go to NLB Subnet"  />
</p>
<p>成功進入 Subnet Details 頁面後：</p>
<ol>
<li>展開 <strong>Actions menu</strong></li>
<li>點擊 <strong>Edit IPv6 CIDRs</strong></li>
</ol>
<p><img loading="lazy" src="image%2010.png" alt="Subnet Edit IPv6 CIDRs"  />
</p>
<p>從 VPC CIDR 中，切一個 <code>/64</code> 的 IPv6 CIDR 給這 Subnet</p>
<p><img loading="lazy" src="image%2011.png" alt="Assign IPv6 CIDR for subnet"  />
</p>
<h3 id="step-3-更新-nlb-ip-address-type">Step 3: 更新 NLB IP address type<a hidden class="anchor" aria-hidden="true" href="#step-3-更新-nlb-ip-address-type">#</a></h3>
<p>當 NLB 所在的 Subnet 已經分配了 IPv6 CIDR 範圍時，可以為 NLB 的 ENI 分配 IPv6 address。不過，NLB 的 ENI 是由 AWS 自動管理，我們無法直接操作或管理這些 ENI。<strong>要為 NLB 的 ENI 分配 IPv6 address，需要修改 NLB 的 IP address type</strong>，例如將其設定為 <code>dualstack</code>，AWS 會自動為 ENI 分配對應的 IPv6 位址。</p>
<p>更改 NLB address type 前，可以去觀察一下 NLB 的 ENI，確實還沒有 IPv6 address (下圖紅框所示)</p>
<p><img loading="lazy" src="image%2012.png" alt="NLB no IPv6 address now"  />
</p>
<p>回到 NLB Details 頁面：</p>
<ol>
<li>展開 <strong>Actions menu</strong></li>
<li>點擊 <strong>Edit IP address type</strong></li>
</ol>
<p><img loading="lazy" src="image%2013.png" alt="Edit IP address type"  />
</p>
<p>把 Load balancer IP address type 改成 <strong>Dualstack</strong></p>
<p><img loading="lazy" src="image%2014.png" alt="Select Dualstack"  />
</p>
<p>再次回到 ENI 頁面，再次觀察 NLB 的 ENI ，可以注意到，已經從 Subnet CIDR 中  Assign 一個 IPv6 address 給 NLB ENI 了 (下圖紅框處)</p>
<p><img loading="lazy" src="image%2015.png" alt="Get IPv6 address"  />
</p>
<h3 id="step-4-修改-nlb-的-security-group-允許-ipv6-流量">Step 4: 修改 NLB 的 Security Group 允許 IPv6 流量<a hidden class="anchor" aria-hidden="true" href="#step-4-修改-nlb-的-security-group-允許-ipv6-流量">#</a></h3>
<p>我們的 NLB 是 Internet-facing 的，原本的 Security Group 只允許任何來源的 IPv4 流量，但我們要接收 IPv6 Client 的流量，勢必就需要修改 Security Group 以允許 IPv6 的流量進入 NLB。</p>
<p>要找到他的 Security Group：</p>
<ul>
<li>可以進入 NLB Detail 的頁面中 &gt; Security 頁籤</li>
<li>就可以找到這個 NLB 的 SG (Security Group)</li>
</ul>
<p><img loading="lazy" src="image%2016.png" alt="Go to NLB SG"  />
</p>
<p>進入 Security Group 頁面：</p>
<ol>
<li>點擊 Edit inbound rules</li>
</ol>
<p><img loading="lazy" src="image%2017.png" alt="Click Edit inbound rules"  />
</p>
<p>配置 Inbound rule 允許 IPv6 流量：</p>
<ol>
<li>點擊 <strong>Add rule</strong></li>
<li><strong>Type:</strong> HTTP</li>
<li><strong>Source:</strong> Anywhere-IPv6</li>
<li><strong>Description:</strong> Allow all HTTP traffic (IPv6)</li>
</ol>
<p><img loading="lazy" src="image%2018.png" alt="Add rule to allow all IPv6 HTTP traffic"  />
</p>
<p>現在可以測試看看能不能把請求成功打進去 NLB 而且還得到回應， <code>curl -6</code> 是 <code>curl</code> 工具的一個選項，專門用於指定使用 <strong>IPv6</strong> 進行請求，如果要用 IPv4 進行請求就是用 <code>-4</code></p>
<p>請把 <code>curl -6</code> 後面那串<strong>換成你自己的 NLB domain name</strong></p>
<p>請把 <code>curl -6</code> 後面那串<strong>換成你自己的 NLB domain name</strong></p>
<p>請把 <code>curl -6</code> 後面那串<strong>換成你自己的 NLB domain name</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -6 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com
</span></span></code></pre></div><p>你會發現打不通，沒有回應！！</p>
<p>你會發現打不通，沒有回應！！</p>
<p>你會發現打不通，沒有回應！！</p>
<h3 id="step-5-修改-route-table-以允許-ipv6-流量出去">Step 5: 修改 Route table 以允許 IPv6 流量出去<a hidden class="anchor" aria-hidden="true" href="#step-5-修改-route-table-以允許-ipv6-流量出去">#</a></h3>
<p>為什麼剛才發出 HTTP 請求後得不到回應呢？原因是：</p>
<ul>
<li>上方指令，我強制使用 IPv6，所以我們是 IPv6 Client</li>
<li>因為 NLB 想要把流量打到外面去，但是路由表內並沒有匹配的 Route 允許他說「當目的地是 XXX IPv6 地址時，下一跳要給誰」</li>
<li>所以我們要修改 Route Table，NLB 才有辦法把流量送回來我們這裡</li>
</ul>
<p>所以！！現在要來修改 NLB ENI 所處的 Subnet 其關聯的 Route table，確保其有 <code>::/0</code> 相關的規則，讓 IPv6 流量可以出去 VPC</p>
<p>進入 NLB Detail 頁面中，點擊 <strong>Availability Zones</strong> 下方的<strong>連結</strong>，找到 NLB 所在的 Subnet</p>
<p><img loading="lazy" src="image%2019.png" alt="Go to NLB Subnet"  />
</p>
<p>進入 VPC Subnets Details 頁面點擊 <strong>Route Table</strong></p>
<p><img loading="lazy" src="image%2020.png" alt="Go to subnet route table"  />
</p>
<p>進入 Route table 頁面：</p>
<ol>
<li>勾選 <strong>Route Table</strong></li>
<li>展開 <strong>Actions menu</strong></li>
<li>點擊 <strong>Edit routes</strong></li>
</ol>
<p><img loading="lazy" src="image%2021.png" alt="Edit routes"  />
</p>
<p>新增 route:</p>
<ul>
<li><strong>Destination:</strong> <code>::/0</code></li>
<li><strong>Target</strong>: Internet Gateway</li>
</ul>
<p><img loading="lazy" src="image%2022.png" alt="Add route"  />
</p>
<p>改好後，再次發出 HTTP 請求</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -6 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;h1&gt;Hello World from ip-10-0-138-176.us-west-2.compute.internal&lt;/h1&gt;
</span></span></code></pre></div><p>太棒了！！終於收到 Response 了，到這邊，<strong>其實可以算是遷移到 Dual-stack 的目標完成一半了！</strong></p>
<p>但是我要追求的是 Fully dual-stack! 也就是 Target Group 那邊也是要 Dual-stack</p>
<h3 id="optional-ssh-連線到-target-group-的-instance-觀察-logs">(Optional) SSH 連線到 Target Group 的 Instance 觀察 Logs<a hidden class="anchor" aria-hidden="true" href="#optional-ssh-連線到-target-group-的-instance-觀察-logs">#</a></h3>
<p>我這邊有用跳板機，連線進去 Target Group 的 Instance 捕捉一下 Private IPv4 Instance 的 Apache httpd Logs，執行以下指令就可以查看 Logs：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo tail -f /var/log/httpd/access_log
</span></span></code></pre></div><p>一樣我先回到自己電腦，用 <code>curl</code> 命令對 NLB 發出請求：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -6 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com
</span></span></code></pre></div><p>然後回到 EC2 Instance 查看 httpd access logs，可以觀察到，來源地址是 NLB 的 Private IPv4 address (10.0.9.20):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>10.0.9.20 - - <span style="color:#f92672">[</span>07/Jan/2025:20:49:00 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">69</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;ELB-HealthChecker/2.0&#34;</span>
</span></span><span style="display:flex;"><span>10.0.9.20 - - <span style="color:#f92672">[</span>07/Jan/2025:20:49:02 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">69</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;curl/8.7.1&#34;</span>
</span></span></code></pre></div><p>透過這個觀察，我們可以知道，當我身為 IPv6 Client，向 NLB 發出 HTTP 請求後，當流量到達時 NLB ，<strong>NLB 會利用自身的 Private IPv4 address 去和 Target 通信</strong>，這也是為什麼我們在 EC2 Instance 觀察 httpd access log 時，看到的來源 IP 地址並不是我電腦的 IPv6 address，而是 NLB 的 Private IPv4 address。</p>
<p>當然我們也可以觀察用 IPv4 去調用，會怎樣：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -4 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com
</span></span></code></pre></div><p>一樣回到 EC2 Instance 查看 httpd access log，觀察到這裡<strong>可以直接看見我電腦的 IPv4 address</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>61.64.29.207 - - <span style="color:#f92672">[</span>08/Jan/2025:01:33:29 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">69</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;curl/8.7.1&#34;</span>
</span></span></code></pre></div><p>會這樣是因為流量從頭到尾都是 IPv4，NLB 不需要在中間幫我們做任何協議的轉換：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>IPv4 Client -&gt; Dual-stack NLB -&gt; IPv4 Target Group Instance
</span></span></code></pre></div><h3 id="optional-利用-vpc-flow-logs-觀察-nlb-的回應">(Optional) 利用 VPC Flow logs 觀察 NLB 的回應<a hidden class="anchor" aria-hidden="true" href="#optional-利用-vpc-flow-logs-觀察-nlb-的回應">#</a></h3>
<blockquote>
<p>VPC Flow Logs 的建置不是本文重點，關於怎麼建置在煩請查閱 <a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html">AWS 官方文檔</a></p>
</blockquote>
<p>我建立了 VPC Flow logs 來觀察 NLB 的 ENI，於是觀察到以下東西：</p>
<ul>
<li>
<p>NLB 確實是以自身 IPv6 address 作為來源地址，將後端應用 (Target Group) 的 Response 回傳到我的電腦</p>
</li>
<li>
<p>為什麼 VPC Flow logs 上面沒見到任何我的筆電 IPv6 地址作為 src？只有看到我的筆電 IPv6 被作為 dst?? 可以看下圖</p>
<ul>
<li>其實即便我今天是 IPv4 Client 也是一樣，就是看不到我的 IP 地址被作為 src 記錄在 VPC Flow logs</li>
<li>這個問題真的讓我很匪夷所思，想了很久，只能**猜測：**某些流量在 NLB 的內部處理過程中未經過 ENI，或者經過特殊的封包處理路徑，這些流量可能不會被 Flow Logs 捕捉到。 (純屬猜測，如果有人知道正確答案希望能分享讓我知道，真的很想探究背後的原因)</li>
</ul>
<p><img loading="lazy" src="image%2023.png" alt="NLB IPv6 address: 2600:1f14:2549:300:17c1:6c5d:ba29:ce1, My IPv6 address: 2407:4b00:1c02:77d9:8041:f560:157a:c42c"  />
</p>
<blockquote>
<p>NLB IPv6 address: 2600:1f14:2549:300:17c1:6c5d:ba29:ce1
My IPv6 address: 2407:4b00:1c02:77d9:8041:f560:157a:c42c</p>
</blockquote>
<p><img loading="lazy" src="image%2024.png" alt="NLB IPv6 address: 2600:1f14:2549:300:17c1:6c5d:ba29:ce1"  />
</p>
</li>
</ul>
<hr>
<h2 id="section2-讓-target-group-也變成-dual-stack">Section2: 讓 Target Group 也變成 Dual-stack<a hidden class="anchor" aria-hidden="true" href="#section2-讓-target-group-也變成-dual-stack">#</a></h2>
<h3 id="step-1-分配-ipv6-cidr-給-target-group-的-instance-所處-subnet">Step 1: 分配 IPv6 CIDR 給 Target Group 的 Instance 所處 subnet<a hidden class="anchor" aria-hidden="true" href="#step-1-分配-ipv6-cidr-給-target-group-的-instance-所處-subnet">#</a></h3>
<p>要找到 EC2 所處的 Subnet，我習慣進入 EC2 頁面，直接找到這台 EC2 所處的 Subnet</p>
<p><img loading="lazy" src="image%2025.png" alt="Go to EC2 Subnet"  />
</p>
<p>進入 VPC Subnet 頁面：</p>
<ol>
<li>選取 <strong>Subnet</strong></li>
<li>展開 <strong>Actions menu</strong></li>
<li>點擊 <strong>Edit IPv6 CIDR</strong></li>
</ol>
<p><img loading="lazy" src="image%2026.png" alt="Assign IPv6 CIDR for EC2 subnet"  />
</p>
<p>從 VPC 中分配一個 <code>/64</code> 的 IPv6 CIDR 子網給他</p>
<p>**注意：**配給這個子網的 CIDR 不要和同 VPC 中的其他 Subnet CIDRs 有 Overlapping!</p>
<p><img loading="lazy" src="image%2027.png" alt="Assign IPv6 CIDR"  />
</p>
<h3 id="step2-assign-ipv6-address-給-instance">Step2: Assign IPv6 address 給 Instance<a hidden class="anchor" aria-hidden="true" href="#step2-assign-ipv6-address-給-instance">#</a></h3>
<p>進入 EC2 頁面：</p>
<ol>
<li>選取 <strong>Instance</strong></li>
<li>展開 <strong>Actions Menu</strong></li>
<li>點擊 <strong>Networking</strong></li>
<li>點擊 <strong>Manage IP addresses</strong></li>
</ol>
<p><img loading="lazy" src="image%2028.png" alt="Go to Manage IP addresses page"  />
</p>
<p>Assign IPv6 Address:</p>
<ol>
<li>展開 <strong>eth0</strong></li>
<li>在 IPv6 addresses 的 Section 下，點擊 <strong>Assign new IP address，欄位可以不填寫</strong>，他會從子網的 IPv6 CIDR 中 Auto-assign</li>
</ol>
<p><img loading="lazy" src="image%2029.png" alt="Assign IPv6 address to EC2"  />
</p>
<h3 id="step-3-建立-ipv6-instance-type-target-group">Step 3: 建立 IPv6 Instance type target group<a hidden class="anchor" aria-hidden="true" href="#step-3-建立-ipv6-instance-type-target-group">#</a></h3>
<p>進入 EC2 &gt; Target Group 頁面：</p>
<ol>
<li>點擊 <strong>Create Target Group</strong></li>
</ol>
<p>依照下方配置 Target Group</p>
<ul>
<li><strong>Target type:</strong> Instances</li>
<li><strong>Target group name:</strong> ipv6-private-instance-tg</li>
<li><strong>Protocol:</strong> Port
<ul>
<li>TCP</li>
<li>80</li>
</ul>
</li>
<li><strong>IP address type: IPv6</strong></li>
<li><strong>VPC:</strong> Instance 所處的 VPC</li>
</ul>
<p>其他保持預設，然後按下 Next</p>
<p><img loading="lazy" src="image%2030.png" alt="Create target group configuration - 1"  />
</p>
<p><img loading="lazy" src="image%2031.png" alt="Create target group configuration - 2"  />
</p>
<p><strong>Register targets:</strong></p>
<ol>
<li><strong>點擊 Unassigned</strong></li>
<li><strong>Manage IP addresses</strong></li>
</ol>
<p><img loading="lazy" src="image%2032.png" alt="Go to Manage IP addresses page"  />
</p>
<p>成功進到 <strong>Manage IP addresses</strong> 頁面：</p>
<ol>
<li>展開 <strong>eth0</strong></li>
<li>勾選 <strong>Enable Assign primary IPv6 IP</strong></li>
<li>點擊 <strong>Save</strong></li>
</ol>
<p><img loading="lazy" src="image%2033.png" alt="Enable Assign primary IPv6 IP"  />
</p>
<p>回到剛才 Target Group 的頁面：</p>
<ol>
<li>點擊右上角 Refresh icon (如下圖紅框所示)</li>
<li>成功的話，你會看到表格中 <strong>Primary IPv6 address 欄位從原本的</strong> <strong>Unassigned 變成顯示對應的 IPv6 address</strong></li>
</ol>
<p><img loading="lazy" src="image%2034.png" alt="Primary IPv6 address is available"  />
</p>
<p>Register targets:</p>
<ol>
<li>勾選 <strong>instance</strong></li>
<li>點擊 <strong>Include as pending below</strong></li>
<li>點擊 <strong>Create target group</strong></li>
</ol>
<p><img loading="lazy" src="image%2035.png" alt="Register targets"  />
</p>
<h3 id="step-4-修改-nlb-listener-的-target">Step 4: 修改 NLB Listener 的 Target<a hidden class="anchor" aria-hidden="true" href="#step-4-修改-nlb-listener-的-target">#</a></h3>
<p>在 NLB 中，<strong>一個 Listener（例如 TCP 80 Port Listener）背後只能關聯一個 Target Group，無法同時直接關聯多個 Target Group。</strong></p>
<p>要跟上趨勢當然就要用 IPv6，所以就來把原本的 IPv4 Target 改成剛才創建好的 IPv6 Target</p>
<p><strong>進入 NLB Detail 頁面：</strong></p>
<ol>
<li>勾選 <strong>Listener</strong></li>
<li>點擊 <strong>Edit listener</strong></li>
</ol>
<p><img loading="lazy" src="image%2036.png" alt="Edit listener"  />
</p>
<p>修改成剛才所創建的 IPv6 Target Group</p>
<p><img loading="lazy" src="image%2037.png" alt="Change to IPv6 Target Group"  />
</p>
<p>切換 TG 後，需要等一下下，因為 NLB 還要做 Health Check 需要一點時間</p>
<p>這時候我回到先前所 SSH 連線的 EC2 Instance 持續觀察 httpd access log 也會發現 Health check 的流量，從原本的 NLB Private IPv4 address 變成 NLB IPv6 address</p>
<blockquote>
<p>補充：
這是目前 NLB ENI 被 Assign 的 Addresses
NLB Private IPv4 address: <code>10.0.9.20</code>
NLB IPv6 address: 2600:1f14:2549:300:7935:fbac:a7b4:84d5</p>
</blockquote>
<p><img loading="lazy" src="image%2038.png" alt="The health check client IP address has turned to IPv6"  />
</p>
<p>到這裡，我們已經成功把 Target Group 升級成 Dual-stack 了！</p>
<h3 id="step-5-測試-ipv6-流量">Step 5: 測試 IPv6 流量<a hidden class="anchor" aria-hidden="true" href="#step-5-測試-ipv6-流量">#</a></h3>
<p>現在我們來使用 <code>curl -6</code> 指令向 Dual-stack NLB 發出 HTTP 請求：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -6 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com
</span></span></code></pre></div><p>流量路徑會是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>IPv6 Client -&gt; Dual-stack NLB <span style="color:#f92672">(</span>Layer 4<span style="color:#f92672">)</span> -&gt; IPv6 Target Group Instance
</span></span></code></pre></div><p>NLB 運作於第 4 層（傳輸層），專門處理傳輸層協議（如 TCP 和 UDP）的流量。由於 NLB 不會對應用層數據進行處理，因此它可以保留封包的原始來源 IP 地址，使後端 Target Group（例如 EC2 Instances）能直接看到 Client 的 IP 地址。</p>
<p>但是要注意，不同的 Target Group 配置會讓保留原始 Client IP 行為略有不同：</p>
<ol>
<li>Target Group 使用實例 ID（Instance ID）：
NLB 會直接保留原始的 Client IP 地址，無需額外設定。</li>
<li>Target Group 使用 IP 地址（IP Address）：
如果使用的是 TCP 或 TLS 協議，NLB 預設不會保留 Client IP 地址。在這種情況下，可以啟用 Proxy Protocol v2，以將原始的 Client IP 地址嵌入到傳遞給目標的封包中。</li>
</ol>
<p>以下是 Target Instance 上 httpd 的 access log，可以看到記錄的是客戶端的 IPv6 地址 <code>2407:4b00:1c02:77d9:8041:f560:157a:c42c</code> (這就是我電腦的 IPv6 address):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>2407:4b00:1c02:77d9:8041:f560:157a:c42c - - <span style="color:#f92672">[</span>07/Jan/2025:22:01:05 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">69</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;curl/8.7.1&#34;</span>
</span></span></code></pre></div><p>也來試試看 IPv4 Client 發出 HTTP 請求：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -4 http://nlb-from-ipv4-to-dual-stack-a7d193e605191856.elb.us-west-2.amazonaws.com
</span></span></code></pre></div><p>你會發現後端看到的來源 IP 是 NLB 的 IPv6 address</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>2600:1f14:2549:300:17c1:6c5d:ba29:ce1 - - <span style="color:#f92672">[</span>08/Jan/2025:02:08:26 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">69</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;curl/8.7.1&#34;</span>
</span></span></code></pre></div><h3 id="optional-既然-nlb-會幫我做協議轉換那我還是想看到原始客戶端-ip-地址怎麼辦">(Optional) 既然 NLB 會幫我做協議轉換，那我還是想看到原始客戶端 IP 地址怎麼辦？<a hidden class="anchor" aria-hidden="true" href="#optional-既然-nlb-會幫我做協議轉換那我還是想看到原始客戶端-ip-地址怎麼辦">#</a></h3>
<p>這時候就需要 Proxy Protocol 的幫助了！</p>
<p>由於這部分不是本文重點，要怎麼在配置 Proxy Protocol 來讓你的 Server 支援 Proxy Protocol 可以參考我的 Notion 筆記，但我這個筆記中是以 Nginx 為示範，跟本文使用 Httpd 不一樣唷：</p>
<ul>
<li>連結：<a href="https://shiun.notion.site/Dual-stack-network-design-in-AWS-173ea7e0d9d080988482c722081d37dc?pvs=97#173ea7e0d9d0802f892ce2b62c8fcd9f">配置 Nginx 支持 Proxy Protocol v2</a></li>
</ul>
<blockquote>
<p>若之後有時間我會重新整理 Notion 筆記中的 Proxy Protocol 的配置，再上傳到部落格</p>
</blockquote>
<hr>
<h2 id="resources">Resources<a hidden class="anchor" aria-hidden="true" href="#resources">#</a></h2>
<ul>
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-cidr-blocks.html">VPC CIDR blocks - Amazon Virtual Private Cloud</a></li>
<li><a href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html">Logging IP traffic using VPC Flow Logs - Amazon Virtual Private Cloud</a></li>
<li><a href="https://www.notion.so/Nginx-Proxy-Protocol-v2-173ea7e0d9d0802f892ce2b62c8fcd9f?pvs=21">配置 Nginx 支持 Proxy Protocol v2 - Shiun Notion</a></li>
<li><a href="https://shiun.notion.site/NLB-IPv4-only-Dual-stack-174ea7e0d9d080e5b0e2cbe31f721c6a?pvs=4">如何將現有 NLB IPv4-only 架構升級為 Dual-stack - Shiun Notion</a></li>
<li><a href="https://shiun.notion.site/Dual-stack-network-design-in-AWS-173ea7e0d9d080988482c722081d37dc?pvs=4">Dual-stack network design in AWS - Shiun Notion</a></li>
<li><a href="https://aws.amazon.com/tw/blogs/networking-and-content-delivery/dual-stack-ipv6-architectures-for-aws-and-hybrid-networks/">Dual-stack IPv6 architectures for AWS and hybrid networks | Amazon Web Services</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://shiun.me/tags/aws/">AWS</a></li>
      <li><a href="https://shiun.me/tags/aws-networking/">AWS Networking</a></li>
      <li><a href="https://shiun.me/tags/aws-elb/">AWS ELB</a></li>
      <li><a href="https://shiun.me/tags/aws-nlb/">AWS NLB</a></li>
      <li><a href="https://shiun.me/tags/dual-stack/">Dual-Stack</a></li>
      <li><a href="https://shiun.me/tags/ipv6/">IPv6</a></li>
      <li><a href="https://shiun.me/tags/aws-vpc/">AWS VPC</a></li>
      <li><a href="https://shiun.me/tags/aws-ec2/">AWS EC2</a></li>
      <li><a href="https://shiun.me/tags/migration/">Migration</a></li>
      <li><a href="https://shiun.me/tags/networking/">Networking</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://shiun.me/blog/tag-based-lambda-warmer-low-cost-high-flexibility/">
    <span class="title">Next »</span>
    <br>
    <span>[Terraform Module] 一個低成本、高靈活性，輕鬆預熱上百個 Lambda Function 的解決方案：Tag-Based Lambda Warmer</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 如何將現有 NLB IPv4-only 架構升級為 Dual-stack on x"
            href="https://x.com/intent/tweet/?text=%e5%a6%82%e4%bd%95%e5%b0%87%e7%8f%be%e6%9c%89%20NLB%20IPv4-only%20%e6%9e%b6%e6%a7%8b%e5%8d%87%e7%b4%9a%e7%82%ba%20Dual-stack&amp;url=https%3a%2f%2fshiun.me%2fblog%2fupgrading-existing-nlb-ipv4-only-to-dual-stack%2f&amp;hashtags=AWS%2cAWSNetworking%2cAWSELB%2cAWSNLB%2cDual-stack%2cIPv6%2cAWSVPC%2cAWSEC2%2cMigration%2cNetworking">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 如何將現有 NLB IPv4-only 架構升級為 Dual-stack on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fshiun.me%2fblog%2fupgrading-existing-nlb-ipv4-only-to-dual-stack%2f&amp;title=%e5%a6%82%e4%bd%95%e5%b0%87%e7%8f%be%e6%9c%89%20NLB%20IPv4-only%20%e6%9e%b6%e6%a7%8b%e5%8d%87%e7%b4%9a%e7%82%ba%20Dual-stack&amp;summary=%e5%a6%82%e4%bd%95%e5%b0%87%e7%8f%be%e6%9c%89%20NLB%20IPv4-only%20%e6%9e%b6%e6%a7%8b%e5%8d%87%e7%b4%9a%e7%82%ba%20Dual-stack&amp;source=https%3a%2f%2fshiun.me%2fblog%2fupgrading-existing-nlb-ipv4-only-to-dual-stack%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 如何將現有 NLB IPv4-only 架構升級為 Dual-stack on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fshiun.me%2fblog%2fupgrading-existing-nlb-ipv4-only-to-dual-stack%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 如何將現有 NLB IPv4-only 架構升級為 Dual-stack on telegram"
            href="https://telegram.me/share/url?text=%e5%a6%82%e4%bd%95%e5%b0%87%e7%8f%be%e6%9c%89%20NLB%20IPv4-only%20%e6%9e%b6%e6%a7%8b%e5%8d%87%e7%b4%9a%e7%82%ba%20Dual-stack&amp;url=https%3a%2f%2fshiun.me%2fblog%2fupgrading-existing-nlb-ipv4-only-to-dual-stack%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
</ul>

  </footer><div class="disqus markdown"><div id="disqus_thread"></div>
<script>
  

  

  (function () {
    
    var d = document,
      s = d.createElement("script");
    s.src = "https://shiun-me.disqus.com/embed.js";
    s.setAttribute("data-timestamp", +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>
</div>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="https://shiun.me/">Shiun</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
